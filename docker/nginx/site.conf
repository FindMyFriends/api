server {
	gzip on;
	gzip_comp_level 9;
	gzip_types application/json;

	listen 80;
	index index.php;
	server_name localhost;
	charset utf-8;
	default_type  application/json;
	error_log  /var/log/nginx/error.log;
	access_log /var/log/nginx/access.log;
	root /var/www/FindMyFriends/www;

	error_page 413 @413_json;
	error_page 403 @403_json;

	add_header Access-Control-Allow-Origin http://localhost:3000;
	add_header Access-Control-Expose-Headers Link,Location,ETag;
	add_header X-Frame-Options DENY;
	add_header X-Content-Type-Options nosniff;
	add_header X-XSS-Protection "1; mode=block";
	add_header Referrer-Policy strict-origin-when-cross-origin;
	add_header Content-Security-Policy "default-src 'none'; script-src 'none'; style-src 'none'; img-src 'none'; font-src 'none'; connect-src 'none'; media-src 'none'; object-src 'none'; child-src 'none'; frame-src 'none'; worker-src 'none'; frame-ancestors 'none'; form-action 'none'; referrer no-referrer";
	fastcgi_hide_header X-Powered-By;
	server_tokens off;

	client_max_body_size 2M;

	location @413_json {
		return 413 '{"message": "Request entity too large"}';
	}

	location @403_json {
		return 403 '{"message": "Forbidden"}';
	}

	location ~* \.json$ {
		expires 1y;
	}

	location / {
		if ($request_method = 'OPTIONS') {
			add_header Access-Control-Allow-Headers Content-Type,Authorization,If-Match;
			add_header Access-Control-Allow-Methods OPTIONS,GET,POST,PUT,PATCH,DELETE;
			add_header Access-Control-Allow-Origin http://localhost:3000;
			add_header Access-Control-Max-Age 1728000; # Tell client that this pre-flight info is valid for 20 days
			add_header Content-Type text/plain;
			add_header Content-Length 0;
			return 204;
		}
		try_files $uri $uri/ /index.php$is_args$args;
	}

	location ~ \.php$ {
		fastcgi_index index.php;
		fastcgi_pass php-fpm:9000;
		include fastcgi_params;
		fastcgi_split_path_info ^(.+?\.php)(/.*)$;
		fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;
		fastcgi_param PATH_INFO $fastcgi_path_info;
	}
}
